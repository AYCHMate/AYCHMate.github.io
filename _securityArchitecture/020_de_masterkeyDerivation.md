---
language: de
anchor: masterkeyDerivation
title: 'Ableitung des "Masterkey"'
---
<p class="lead">Each vault has its own 256 bit encryption as well as MAC masterkey used for encryption of file specific keys and file authentication respectively.</p>

These keys are random sequences generated by a <abbr title="Cryptographically secure pseudorandom number generator" class="initialism">CSPRNG</abbr>.
Both keys are encrypted using <a href="https://tools.ietf.org/html/rfc3394" target="_blank">RFC 3394</a> key wrapping with a <abbr title="Key encrypting key" class="initialism">KEK</abbr> derived from the user&apos;s password using Scrypt.

<pre>
encryptionMasterKey := createRandomBytes(32)
macMasterKey := createRandomBytes(32)
kek := scrypt(password, scryptSalt, scryptCostParam, scryptBlockSize)
wrappedEncryptionMasterKey := aesKeyWrap(encryptionMasterKey, kek)
wrappedMacMasterKey := aesKeyWrap(macMasterKey, kek)
</pre>

The wrapped keys and the parameters needed to derive the KEK are then stored as integers or Base64 strings in a JSON file named <code>masterkey.cryptomator</code>, which is located in the root directory of the vault.

When unlocking a vault the KEK is used to unwrap (i.e. decrypt) the stored masterkeys.

<pre>
{
  "version": 3, /* vault version for checking software compatibility */
  "scryptSalt": "QGk...jY=",
  "scryptCostParam": 16384,
  "scryptBlockSize": 8,
  "primaryMasterKey": "QDi...Q==", /* wrappedEncryptionMasterKey */
  "hmacMasterKey": "L83...Q==", /* wrappedMacMasterKey */
  "versionMac": "3/U...9Q=" /* HMAC-256 of vault version to prevent downgrade attacks */
}
</pre>
